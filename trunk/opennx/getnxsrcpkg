#!/usr/bin/perl

my @urls;
my $do_fetch = 1;

if ($#ARGV ge 0) {
	if ($ARGV[0] eq '-l') {
		$do_fetch = 0;
		shift(@ARGV);
	}
}

my $have_wget = (`which wget` ne '');

if ($have_wget) {
	open(P, "wget -q -O - http://www.nomachine.com/sources.php|") || die "Can't run wget: $!\n";
} else {
	open(P, "curl -f -L http://www.nomachine.com/sources.php|") || die "Can't run wget: $!\n";
}
while (<P>) {
        chomp;
        if (/A\s+HREF="([^"]+)"\s+class=link2/) {
                push @urls, $1;
        }
}
close P;

if ($#urls eq 0) {
    print "Nothing to download\n";
    exit(0);
}

foreach (@urls) {
    my $skipit = 0;
    my $fn = $_;
    $fn =~ s/.*\///;
    if ($#ARGV ge 0) {
        $skipit = 1;
        foreach $req (@ARGV) {
            $skipit = 0 if ($fn =~ m/^$req\-/);
        }
        next if ($skipit);
    }
    if ($do_fetch) {
        print "Fetching $fn ...";
if ($have_wget) {
        system("wget -q $_");
} else {
	my $of = $_;
	$of =~ s/.*\///;
        system("curl -f -L -o $of $_");
}
        print " done\n";
    } else {
        print "$fn\n";
    }
}
